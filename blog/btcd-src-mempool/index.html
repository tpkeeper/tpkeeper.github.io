<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.71.0-DEV" />


<title>btcd 源码分析系列：6 - mempool - 大远的博客</title>
<meta property="og:title" content="btcd 源码分析系列：6 - mempool - 大远的博客">


  <link href='http://www.tpkeep.com/favicon.jpg' rel='icon' type='image/x-icon'/>



  










<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/">首页</a></li>
    
    <li><a href="/post">归档</a></li>
    
    <li><a href="/tags">标签</a></li>
    
    <li><a href="/categories">分类</a></li>
    
    <li><a href="/about">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">5 min read</span>
    

    <h1 class="article-title">btcd 源码分析系列：6 - mempool</h1>

    
    <span class="article-date">2019-08-30</span>
    

    <div class="article-content">
      <blockquote>
<p>参考：<a href="https://github.com/btcsuite/btcd/tree/master/mempool">btcd</a></p>
</blockquote>
<ul>
<li>btcd提供了一个内存池mempool，用于存储还未被矿工打包的交易。</li>
<li>utxo和block index存储于leveldb中，而不是本文讨论的mempool</li>
<li>被插入之前要进行一系列的正确性验证（通过mabeAcceptTransaction）。</li>
<li>如果是orphan tx（即在main chain和mempool里找不到input的所属交易tx）会暂时插入到orphans pool（通过ProcessTransaction）。</li>
<li>当新的block连接到主链时，会把block中的tx从mempool中移除，相应的也会转移orphans pool中依赖此block的tx到mempool中（通过MabeAcceptTransaction）</li>
<li>当block从主链脱离时，会重新处理block里的tx(通过MabeAcceptTransaction)</li>
</ul>
<h2 id="一创建mempool对象">一、创建mempool对象</h2>
<ul>
<li>
<p>在server被创建的时候调用此方法生成一个mempool对象</p>
</li>
<li>
<p>可以看到，pool用来存储正常的tx，orphans存储orphan tx</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// New returns a new memory pool for validating and storing standalone
</span><span style="color:#75715e">// transactions until they are mined into a block.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Config</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">TxPool</span>{
        <span style="color:#a6e22e">cfg</span>:            <span style="color:#f92672">*</span><span style="color:#a6e22e">cfg</span>,
        <span style="color:#a6e22e">pool</span>:           make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">Hash</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">TxDesc</span>),
        <span style="color:#a6e22e">orphans</span>:        make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">Hash</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">orphanTx</span>),
        <span style="color:#a6e22e">orphansByPrev</span>:  make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">OutPoint</span>]<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">Hash</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">btcutil</span>.<span style="color:#a6e22e">Tx</span>),
        <span style="color:#a6e22e">nextExpireScan</span>: <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">orphanExpireScanInterval</span>),
        <span style="color:#a6e22e">outpoints</span>:      make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">OutPoint</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">btcutil</span>.<span style="color:#a6e22e">Tx</span>),
    }
}
</code></pre></div></li>
</ul>
<h4 id="二processtransaction">二、ProcessTransaction</h4>
<ul>
<li>
<p>该方法用来处理通过rpc请求（handleSendRawTransaction）发送的的rawtx和通过p2p网络（OnTx）同步的tx</p>
</li>
<li>
<p>支持orphan tx的插入</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// ProcessTransaction is the main workhorse for handling insertion of new
</span><span style="color:#75715e">// free-standing transactions into the memory pool.  It includes functionality
</span><span style="color:#75715e">// such as rejecting duplicate transactions, ensuring transactions follow all
</span><span style="color:#75715e">// rules, orphan transaction handling, and insertion into the memory pool.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// It returns a slice of transactions added to the mempool.  When the
</span><span style="color:#75715e">// error is nil, the list will include the passed transaction itself along
</span><span style="color:#75715e">// with any additional orphan transaactions that were added as a result of
</span><span style="color:#75715e">// the passed one being accepted.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// This function is safe for concurrent access.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">ProcessTransaction</span>(<span style="color:#a6e22e">tx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">btcutil</span>.<span style="color:#a6e22e">Tx</span>, <span style="color:#a6e22e">allowOrphan</span>, <span style="color:#a6e22e">rateLimit</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">tag</span> <span style="color:#a6e22e">Tag</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">TxDesc</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Tracef</span>(<span style="color:#e6db74">&#34;Processing transaction %v&#34;</span>, <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Hash</span>())

    <span style="color:#75715e">// Protect concurrent access.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()

    <span style="color:#75715e">// Potentially accept the transaction to the memory pool.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">missingParents</span>, <span style="color:#a6e22e">txD</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">maybeAcceptTransaction</span>(<span style="color:#a6e22e">tx</span>, <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">rateLimit</span>,
        <span style="color:#66d9ef">true</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }

    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">missingParents</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#75715e">// Accept any orphan transactions that depend on this
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// transaction (they may no longer be orphans if all inputs
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// are now available) and repeat for those accepted
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// transactions until there are no more.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">newTxs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">processOrphans</span>(<span style="color:#a6e22e">tx</span>)
        <span style="color:#a6e22e">acceptedTxs</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">TxDesc</span>, len(<span style="color:#a6e22e">newTxs</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)

        <span style="color:#75715e">// Add the parent transaction first so remote nodes
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// do not add orphans.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">acceptedTxs</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#a6e22e">txD</span>
        copy(<span style="color:#a6e22e">acceptedTxs</span>[<span style="color:#ae81ff">1</span>:], <span style="color:#a6e22e">newTxs</span>)

        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">acceptedTxs</span>, <span style="color:#66d9ef">nil</span>
    }

    <span style="color:#75715e">// The transaction is an orphan (has inputs missing).  Reject
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// it if the flag to allow orphans is not set.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">allowOrphan</span> {
        <span style="color:#75715e">// Only use the first missing parent transaction in
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// the error message.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// NOTE: RejectDuplicate is really not an accurate
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// reject code here, but it matches the reference
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// implementation and there isn&#39;t a better choice due
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// to the limited number of reject codes.  Missing
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// inputs is assumed to mean they are already spent
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// which is not really always the case.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">str</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;orphan transaction %v references &#34;</span><span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34;outputs of unknown or fully-spent &#34;</span><span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34;transaction %v&#34;</span>, <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Hash</span>(), <span style="color:#a6e22e">missingParents</span>[<span style="color:#ae81ff">0</span>])
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">txRuleError</span>(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">RejectDuplicate</span>, <span style="color:#a6e22e">str</span>)
    }

    <span style="color:#75715e">// Potentially add the orphan transaction to the orphan pool.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">maybeAddOrphan</span>(<span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">tag</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div></li>
</ul>
<h4 id="三maybeaccepttransaction">三、MaybeAcceptTransaction</h4>
<ul>
<li>
<p>当block 从主链 connect / disconnect 的时候(blockchain.NTBlockConnected/blockchain.NTBlockDisconnected)，使用此函数处理block中的tx（当然不会包含coinbase）</p>
</li>
<li>
<p>不支持orphan tx的插入</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// MaybeAcceptTransaction is the main workhorse for handling insertion of new
</span><span style="color:#75715e">// free-standing transactions into a memory pool.  It includes functionality
</span><span style="color:#75715e">// such as rejecting duplicate transactions, ensuring transactions follow all
</span><span style="color:#75715e">// rules, detecting orphan transactions, and insertion into the memory pool.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// If the transaction is an orphan (missing parent transactions), the
</span><span style="color:#75715e">// transaction is NOT added to the orphan pool, but each unknown referenced
</span><span style="color:#75715e">// parent is returned.  Use ProcessTransaction instead if new orphans should
</span><span style="color:#75715e">// be added to the orphan pool.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// This function is safe for concurrent access.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">MaybeAcceptTransaction</span>(<span style="color:#a6e22e">tx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">btcutil</span>.<span style="color:#a6e22e">Tx</span>, <span style="color:#a6e22e">isNew</span>, <span style="color:#a6e22e">rateLimit</span> <span style="color:#66d9ef">bool</span>) ([]<span style="color:#f92672">*</span><span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">Hash</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">TxDesc</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// Protect concurrent access.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
    <span style="color:#a6e22e">hashes</span>, <span style="color:#a6e22e">txD</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">maybeAcceptTransaction</span>(<span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">isNew</span>, <span style="color:#a6e22e">rateLimit</span>, <span style="color:#66d9ef">true</span>)
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">hashes</span>, <span style="color:#a6e22e">txD</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div></li>
</ul>
<h2 id="四mabeaccepttransaction">四、mabeAcceptTransaction</h2>
<ul>
<li>ProcessTransaction和MabeAcceptTransaction最终都调用的该方法</li>
<li>该方法会做一系列合法性验证然后将tx插入mempool</li>
</ul>
<h2 id="五processorhpans">五、ProcessOrhpans</h2>
<ul>
<li>
<p>当有新的block connect 到主链时，对block中的每一个tx都检测是否存在基于它的orphan tx，并将存在的tx移到mempool中</p>
<pre><code>// ProcessOrphans determines if there are any orphans which depend on the passed
// transaction hash (it is possible that they are no longer orphans) and
// potentially accepts them to the memory pool.  It repeats the process for the
// newly accepted transactions (to detect further orphans which may no longer be
// orphans) until there are no more.
//
// It returns a slice of transactions added to the mempool.  A nil slice means
// no transactions were moved from the orphan pool to the mempool.
//
// This function is safe for concurrent access.
func (mp *TxPool) ProcessOrphans(acceptedTx *btcutil.Tx) []*TxDesc {
    mp.mtx.Lock()
    acceptedTxns := mp.processOrphans(acceptedTx)
    mp.mtx.Unlock()

    return acceptedTxns
}
</code></pre></li>
</ul>
<h2 id="六fetchtransaction">六、Fetchtransaction</h2>
<ul>
<li>
<p>从mem pool中获取对应hash的tx，不包含orphans pool</p>
</li>
<li>
<p>在rpc请求的一些方法（searchrawtransactions、getrawtransaction、gettxout、）和p2p网络发送txmsg使用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// FetchTransaction returns the requested transaction from the transaction pool.
</span><span style="color:#75715e">// This only fetches from the main transaction pool and does not include
</span><span style="color:#75715e">// orphans.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// This function is safe for concurrent access.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">FetchTransaction</span>(<span style="color:#a6e22e">txHash</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">Hash</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">btcutil</span>.<span style="color:#a6e22e">Tx</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// Protect concurrent access.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">RLock</span>()
    <span style="color:#a6e22e">txDesc</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">pool</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">txHash</span>]
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">RUnlock</span>()

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">exists</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">txDesc</span>.<span style="color:#a6e22e">Tx</span>, <span style="color:#66d9ef">nil</span>
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;transaction is not in the pool&#34;</span>)
}
</code></pre></div></li>
</ul>
<h4 id="七miningdescs">七、MiningDescs</h4>
<ul>
<li>
<p>rpc getBlockTemplate 使用此方法生成挖矿需要的数据</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// MiningDescs returns a slice of mining descriptors for all the transactions
</span><span style="color:#75715e">// in the pool.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// This is part of the mining.TxSource interface implementation and is safe for
</span><span style="color:#75715e">// concurrent access as required by the interface contract.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">MiningDescs</span>() []<span style="color:#f92672">*</span><span style="color:#a6e22e">mining</span>.<span style="color:#a6e22e">TxDesc</span> {
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">RLock</span>()
    <span style="color:#a6e22e">descs</span> <span style="color:#f92672">:=</span> make([]<span style="color:#f92672">*</span><span style="color:#a6e22e">mining</span>.<span style="color:#a6e22e">TxDesc</span>, len(<span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">pool</span>))
    <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">desc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">pool</span> {
        <span style="color:#a6e22e">descs</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">desc</span>.<span style="color:#a6e22e">TxDesc</span>
        <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
    }
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">RUnlock</span>()

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">descs</span>
}
</code></pre></div></li>
</ul>
<h2 id="八removetransaction">八、RemoveTransaction</h2>
<ul>
<li>
<p>从mempool中移除交易</p>
</li>
<li>
<p>当有新的block connect到主链时，移除block中的transaction</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// RemoveTransaction removes the passed transaction from the mempool. When the
</span><span style="color:#75715e">// removeRedeemers flag is set, any transactions that redeem outputs from the
</span><span style="color:#75715e">// removed transaction will also be removed recursively from the mempool, as
</span><span style="color:#75715e">// they would otherwise become orphans.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// This function is safe for concurrent access.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">RemoveTransaction</span>(<span style="color:#a6e22e">tx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">btcutil</span>.<span style="color:#a6e22e">Tx</span>, <span style="color:#a6e22e">removeRedeemers</span> <span style="color:#66d9ef">bool</span>) {
    <span style="color:#75715e">// Protect concurrent access.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">removeTransaction</span>(<span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">removeRedeemers</span>)
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()
}

</code></pre></div></li>
</ul>
<h2 id="九checkpooldoublespend">九、checkPoolDoubleSpend</h2>
<ul>
<li>
<p>双花检测</p>
</li>
<li>
<p>通过对比 待插入txin的PreviousOutPoint和内存池里边的已经存在的outpoints</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// checkPoolDoubleSpend checks whether or not the passed transaction is
</span><span style="color:#75715e">// attempting to spend coins already spent by other transactions in the pool.
</span><span style="color:#75715e">// Note it does not check for double spends against transactions already in the
</span><span style="color:#75715e">// main chain.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// This function MUST be called with the mempool lock held (for reads).
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">checkPoolDoubleSpend</span>(<span style="color:#a6e22e">tx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hcutil</span>.<span style="color:#a6e22e">Tx</span>, <span style="color:#a6e22e">txType</span> <span style="color:#a6e22e">stake</span>.<span style="color:#a6e22e">TxType</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">txIn</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">MsgTx</span>().<span style="color:#a6e22e">TxIn</span> {
        <span style="color:#75715e">// We don&#39;t care about double spends of stake bases.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span>  <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#a6e22e">txType</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">stake</span>.<span style="color:#a6e22e">TxTypeSSGen</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">txType</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">stake</span>.<span style="color:#a6e22e">TxTypeSSRtx</span>) {
            <span style="color:#66d9ef">continue</span>
        }

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">txR</span>, <span style="color:#a6e22e">exists</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">outpoints</span>[<span style="color:#a6e22e">txIn</span>.<span style="color:#a6e22e">PreviousOutPoint</span>]; <span style="color:#a6e22e">exists</span> {
            <span style="color:#a6e22e">str</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;transaction %v in the pool &#34;</span><span style="color:#f92672">+</span>
                <span style="color:#e6db74">&#34;already spends the same coins&#34;</span>, <span style="color:#a6e22e">txR</span>.<span style="color:#a6e22e">Hash</span>())
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">txRuleError</span>(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">RejectDuplicate</span>, <span style="color:#a6e22e">str</span>)
        }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div></li>
<li>
<p>outpoint 包含hash和索引</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// OutPoint defines a HC data type that is used to track previous
</span><span style="color:#75715e">// transaction outputs.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">OutPoint</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Hash</span>  <span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">Hash</span>
    <span style="color:#a6e22e">Index</span> <span style="color:#66d9ef">uint32</span>
    <span style="color:#a6e22e">Tree</span>  <span style="color:#66d9ef">int8</span>
}

</code></pre></div></li>
</ul>
<h2 id="十pruneexpiredtx">十、PruneExpiredTx</h2>
<ul>
<li>
<p>根据高度移除过期交易</p>
</li>
<li>
<p>当从其他peer同步到一个块的时候和重组的时候发生</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// PruneExpiredTx prunes expired transactions from the mempool that may no longer
</span><span style="color:#75715e">// be able to be included into a block.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">PruneExpiredTx</span>(<span style="color:#a6e22e">height</span> <span style="color:#66d9ef">int64</span>) {
    <span style="color:#75715e">// Protect concurrent access.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">pruneExpiredTx</span>(<span style="color:#a6e22e">height</span>)
    <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TxPool</span>) <span style="color:#a6e22e">pruneExpiredTx</span>(<span style="color:#a6e22e">height</span> <span style="color:#66d9ef">int64</span>) {
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">tx</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">pool</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Tx</span>.<span style="color:#a6e22e">MsgTx</span>().<span style="color:#a6e22e">Expiry</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">height</span> <span style="color:#f92672">&gt;=</span> int64(<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Tx</span>.<span style="color:#a6e22e">MsgTx</span>().<span style="color:#a6e22e">Expiry</span>) {
                <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Pruning expired transaction %v &#34;</span><span style="color:#f92672">+</span>
                    <span style="color:#e6db74">&#34;from the mempool&#34;</span>, <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Tx</span>.<span style="color:#a6e22e">Hash</span>())
                <span style="color:#a6e22e">mp</span>.<span style="color:#a6e22e">removeTransaction</span>(<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Tx</span>, <span style="color:#66d9ef">true</span>)
            }
        }
    }
}
</code></pre></div></li>
</ul>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js//highlight.min.js"></script>



<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166290945-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

