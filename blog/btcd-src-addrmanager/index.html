<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.71.0-DEV" />


<title>btcd 源码分析系列：2 - addrmanager - 大远的博客</title>
<meta property="og:title" content="btcd 源码分析系列：2 - addrmanager - 大远的博客">


  <link href='http://www.tpkeep.com/favicon.jpg' rel='icon' type='image/x-icon'/>



  










<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/">首页</a></li>
    
    <li><a href="/post">归档</a></li>
    
    <li><a href="/tags">标签</a></li>
    
    <li><a href="/categories">分类</a></li>
    
    <li><a href="/about">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">2 min read</span>
    

    <h1 class="article-title">btcd 源码分析系列：2 - addrmanager</h1>

    
    <span class="article-date">2019-08-30</span>
    

    <div class="article-content">
      <blockquote>
<p>参考：<a href="https://github.com/btcsuite/btcd/tree/master/addrmgr">btcd</a></p>
</blockquote>
<ul>
<li>addrmanager 主要提供了peer地址的管理功能，包括地址的增删查改</li>
<li>通过存储json序列化后的数据到本地文件实现持久化</li>
<li>btc启动的时候，会读取该json文件，将保存的节点信息读取到内存中</li>
<li>btc运行的过程中，每过一段时间（十分钟）就持久化一次，以备下次启动时使用</li>
<li>btc退出时，会再次持久化一次</li>
</ul>
<h2 id="一创建addrmanager对象">一、创建addrmanager对象</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// New returns a new bitcoin address manager.
</span><span style="color:#75715e">// Use Start to begin processing asynchronous address updates.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">dataDir</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">lookupFunc</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">string</span>) ([]<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#66d9ef">error</span>)) <span style="color:#f92672">*</span><span style="color:#a6e22e">AddrManager</span> {
	<span style="color:#a6e22e">am</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">AddrManager</span>{
		<span style="color:#a6e22e">peersFile</span>:      <span style="color:#a6e22e">filepath</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">dataDir</span>, <span style="color:#e6db74">&#34;peers.json&#34;</span>),
		<span style="color:#a6e22e">lookupFunc</span>:     <span style="color:#a6e22e">lookupFunc</span>,
		<span style="color:#a6e22e">rand</span>:           <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">NewSource</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>())),
		<span style="color:#a6e22e">quit</span>:           make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}),
		<span style="color:#a6e22e">localAddresses</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">localAddress</span>),
		<span style="color:#a6e22e">version</span>:        <span style="color:#a6e22e">serialisationVersion</span>,
	}
	<span style="color:#a6e22e">am</span>.<span style="color:#a6e22e">reset</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">am</span>
}
</code></pre></div><h2 id="二启动">二、启动</h2>
<ul>
<li>
<p>通过started字段保证一个addrManager只能start一次</p>
</li>
<li>
<p>loadPeers()就是读取硬盘上保存的peer信息到内存中</p>
</li>
<li>
<p>addressHander 启动一个协程处理周期性的持久化和</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Start begins the core address handler which manages a pool of known
</span><span style="color:#75715e">// addresses, timeouts, and interval based writes.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AddrManager</span>) <span style="color:#a6e22e">Start</span>() {
    <span style="color:#75715e">// Already started?
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">started</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
        <span style="color:#66d9ef">return</span>
    }

    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#e6db74">&#34;Starting address manager&#34;</span>)

    <span style="color:#75715e">// Load peers we already know about from file.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">loadPeers</span>()

    <span style="color:#75715e">// Start the address ticker to save addresses periodically.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">addressHandler</span>()
}
</code></pre></div></li>
</ul>
<h2 id="三停止">三、停止</h2>
<ul>
<li>
<p>stop的时候通过close channel 通知并等待子协程（处理持久化任务）的退出</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Stop gracefully shuts down the address manager by stopping the main handler.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AddrManager</span>) <span style="color:#a6e22e">Stop</span>() <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">shutdown</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;Address manager is already in the process of &#34;</span> <span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34;shutting down&#34;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
    }

    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Address manager shutting down&#34;</span>)
    close(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">quit</span>)
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">// addressHandler is the main handler for the address manager.  It must be run
</span><span style="color:#75715e">// as a goroutine.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AddrManager</span>) <span style="color:#a6e22e">addressHandler</span>() {
    <span style="color:#a6e22e">dumpAddressTicker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">dumpAddressInterval</span>)
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">dumpAddressTicker</span>.<span style="color:#a6e22e">Stop</span>()
<span style="color:#a6e22e">out</span>:
    <span style="color:#66d9ef">for</span> {
        <span style="color:#66d9ef">select</span> {
        <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">dumpAddressTicker</span>.<span style="color:#a6e22e">C</span>:
            <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">savePeers</span>()

        <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">quit</span>:
            <span style="color:#66d9ef">break</span> <span style="color:#a6e22e">out</span>
        }
    }
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">savePeers</span>()
    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#e6db74">&#34;Address handler done&#34;</span>)
}
</code></pre></div></li>
</ul>
<h2 id="四获取地址">四、获取地址</h2>
<ul>
<li>
<p>用了自己的随机算法选取部分地址返回</p>
</li>
<li>
<p>这个随机算法简单的说就是，先根据百分比确定返回的数量max，然后选中第i个，并与i-n之间的随机一个交换，i从0依次递增到max-1，这样一共选出来max个</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// AddressCache returns the current address cache.  It must be treated as
</span><span style="color:#75715e">// read-only (but since it is a copy now, this is not as dangerous).
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AddrManager</span>) <span style="color:#a6e22e">AddressCache</span>() []<span style="color:#f92672">*</span><span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NetAddress</span> {
    <span style="color:#a6e22e">allAddr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">getAddresses</span>()

    <span style="color:#a6e22e">numAddresses</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">allAddr</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">getAddrPercent</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">100</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">numAddresses</span> &gt; <span style="color:#a6e22e">getAddrMax</span> {
        <span style="color:#a6e22e">numAddresses</span> = <span style="color:#a6e22e">getAddrMax</span>
    }

    <span style="color:#75715e">// Fisher-Yates shuffle the array. We only need to do the first
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// `numAddresses&#39; since we are throwing the rest.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">numAddresses</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
        <span style="color:#75715e">// pick a number between current index and the end
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Intn</span>(len(<span style="color:#a6e22e">allAddr</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">i</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">i</span>
        <span style="color:#a6e22e">allAddr</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">allAddr</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#a6e22e">allAddr</span>[<span style="color:#a6e22e">j</span>], <span style="color:#a6e22e">allAddr</span>[<span style="color:#a6e22e">i</span>]
    }

    <span style="color:#75715e">// slice off the limit we are willing to share.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">allAddr</span>[<span style="color:#ae81ff">0</span>:<span style="color:#a6e22e">numAddresses</span>]
}

</code></pre></div></li>
</ul>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js//highlight.min.js"></script>



<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166290945-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

