<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.71.0-DEV" />


<title>btcd 源码分析系列：7 - rpc - 大远的博客</title>
<meta property="og:title" content="btcd 源码分析系列：7 - rpc - 大远的博客">


  <link href='http://www.tpkeep.com/favicon.jpg' rel='icon' type='image/x-icon'/>



  










<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/">首页</a></li>
    
    <li><a href="/post">归档</a></li>
    
    <li><a href="/tags">标签</a></li>
    
    <li><a href="/categories">分类</a></li>
    
    <li><a href="/about">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">2 min read</span>
    

    <h1 class="article-title">btcd 源码分析系列：7 - rpc</h1>

    
    <span class="article-date">2019-08-30</span>
    

    <div class="article-content">
      <blockquote>
<p>参考：<a href="https://github.com/btcsuite/btcd/blob/master/rpcserver.go">btcd</a></p>
</blockquote>
<ul>
<li>btcd实现了基于http的和websocket的json-rpc,支持http Basic authentication。</li>
<li>websocket通道 支持所有的请求类型，http通道不支持通知类（notify）的请求</li>
<li>http/websocket是传输协议，json是序列化协议。</li>
</ul>
<h2 id="一start">一、start</h2>
<ul>
<li>
<p>启动一个server,监听路径&rdquo;/&ldquo;和&rdquo;/ws&rdquo;,分别对应http/websocket。</p>
</li>
<li>
<p>通过chedkAuth()函数认证，基于Basic authentication</p>
</li>
<li>
<p>通过limitConnections（）对单个地址的并发连接数量做限制</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">rpcServeMux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
        <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Connection&#34;</span>, <span style="color:#e6db74">&#34;close&#34;</span>)
        <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Content-Type&#34;</span>, <span style="color:#e6db74">&#34;application/json&#34;</span>)
        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Close</span> = <span style="color:#66d9ef">true</span>

        <span style="color:#75715e">// Limit the number of connections to max allowed.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">limitConnections</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RemoteAddr</span>) {
            <span style="color:#66d9ef">return</span>
        }

        <span style="color:#75715e">// Keep track of the number of connected clients.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">incrementClients</span>()
        <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">decrementClients</span>()
        <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">isAdmin</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">checkAuth</span>(<span style="color:#a6e22e">r</span>, <span style="color:#66d9ef">true</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">jsonAuthFail</span>(<span style="color:#a6e22e">w</span>)
            <span style="color:#66d9ef">return</span>
        }

        <span style="color:#75715e">// Read and respond to the request.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">jsonRPCRead</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">isAdmin</span>)
    })

    <span style="color:#75715e">// Websocket endpoint.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rpcServeMux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/ws&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
        <span style="color:#a6e22e">authenticated</span>, <span style="color:#a6e22e">isAdmin</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">checkAuth</span>(<span style="color:#a6e22e">r</span>, <span style="color:#66d9ef">false</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#a6e22e">jsonAuthFail</span>(<span style="color:#a6e22e">w</span>)
            <span style="color:#66d9ef">return</span>
        }

        <span style="color:#75715e">// Attempt to upgrade the connection to a websocket connection
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// using the default size for read/write buffers.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ws</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">websocket</span>.<span style="color:#a6e22e">Upgrade</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#a6e22e">websocket</span>.<span style="color:#a6e22e">HandshakeError</span>); !<span style="color:#a6e22e">ok</span> {
                <span style="color:#a6e22e">rpcsLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Unexpected websocket error: %v&#34;</span>,
                    <span style="color:#a6e22e">err</span>)
            }
            <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;400 Bad Request.&#34;</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusBadRequest</span>)
            <span style="color:#66d9ef">return</span>
        }
        <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">WebsocketHandler</span>(<span style="color:#a6e22e">ws</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RemoteAddr</span>, <span style="color:#a6e22e">authenticated</span>, <span style="color:#a6e22e">isAdmin</span>)
    })

</code></pre></div></li>
</ul>
<h2 id="二解析参数">二、解析参数</h2>
<ul>
<li>
<p>通过对body进行unmarshal，可以直接拿到此结构</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Jsonrpc</span> <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;jsonrpc&#34;`</span>
    <span style="color:#a6e22e">Method</span>  <span style="color:#66d9ef">string</span>            <span style="color:#e6db74">`json:&#34;method&#34;`</span>
    <span style="color:#a6e22e">Params</span>  []<span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">RawMessage</span> <span style="color:#e6db74">`json:&#34;params&#34;`</span>
    <span style="color:#a6e22e">ID</span>      <span style="color:#66d9ef">interface</span>{}       <span style="color:#e6db74">`json:&#34;id&#34;`</span>
}
</code></pre></div></li>
<li>
<p>进一步通过反射拿到此结构体，cmd对应method cmd（实际上就是参数）的结构体反射值</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">parsedRPCCmd</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">id</span>     <span style="color:#66d9ef">interface</span>{}
    <span style="color:#a6e22e">method</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">cmd</span>    <span style="color:#66d9ef">interface</span>{}
    <span style="color:#a6e22e">err</span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">hcjson</span>.<span style="color:#a6e22e">RPCError</span>
}
</code></pre></div></li>
<li>
<p>一个具体的method,对应的cmd结构体，也就是method的参数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// CreateRawTransactionCmd defines the createrawtransaction JSON-RPC command.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CreateRawTransactionCmd</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Inputs</span>   []<span style="color:#a6e22e">TransactionInput</span>
    <span style="color:#a6e22e">Amounts</span>  <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">float64</span> <span style="color:#e6db74">`jsonrpcusage:&#34;{\&#34;address\&#34;:amount,...}&#34;`</span> <span style="color:#75715e">// In HC
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">LockTime</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int64</span>
    <span style="color:#a6e22e">PayLoad</span>  <span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>
}
</code></pre></div></li>
</ul>
<h2 id="三执行">三、执行</h2>
<ul>
<li>
<p>通过method找到相应的handler，传入之前拿到的参数，并执行</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rpcServer</span>) <span style="color:#a6e22e">standardCmdResult</span>(<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">parsedRPCCmd</span>, <span style="color:#a6e22e">closeChan</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">handler</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rpcHandlers</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">method</span>]
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
        <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">handled</span>
    }
    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">rpcAskWallet</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">method</span>]
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
        <span style="color:#a6e22e">handler</span> = <span style="color:#a6e22e">handleAskWallet</span>
        <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">handled</span>
    }
    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ok</span> = <span style="color:#a6e22e">rpcUnimplemented</span>[<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">method</span>]
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ok</span> {
        <span style="color:#a6e22e">handler</span> = <span style="color:#a6e22e">handleUnimplemented</span>
        <span style="color:#66d9ef">goto</span> <span style="color:#a6e22e">handled</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">hcjson</span>.<span style="color:#a6e22e">ErrRPCMethodNotFound</span>
<span style="color:#a6e22e">handled</span>:

    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handler</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">closeChan</span>)
}

</code></pre></div></li>
<li>
<p>具体的执行方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#75715e">// handleCreateRawTransaction handles createrawtransaction commands.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handleCreateRawTransaction</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rpcServer</span>, <span style="color:#a6e22e">cmd</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">closeChan</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
    <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cmd</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">hcjson</span>.<span style="color:#a6e22e">CreateRawTransactionCmd</span>)

    <span style="color:#75715e">// Validate the locktime, if given.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">LockTime</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span>
        (<span style="color:#f92672">*</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">LockTime</span> &lt; <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
            <span style="color:#f92672">*</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">LockTime</span> &gt; int64(<span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">MaxTxInSequenceNum</span>)) {
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">rpcInvalidError</span>(<span style="color:#e6db74">&#34;Locktime out of range&#34;</span>)
    }

    <span style="color:#75715e">// Add all transaction inputs to a new transaction after performing
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// some validity checks.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mtx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">wire</span>.<span style="color:#a6e22e">NewMsgTx</span>()
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">input</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Inputs</span> {
        <span style="color:#a6e22e">txHash</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">NewHashFromStr</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Txid</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">rpcDecodeHexError</span>(<span style="color:#a6e22e">input</span>.<span style="color:#a6e22e">Txid</span>)
        }
}
</code></pre></div></li>
</ul>
<h2 id="四返回">四、返回</h2>
<ul>
<li>
<p>最后将结果序列化并返回，responseID=requestID</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#75715e">// Marshal the response.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">createMarshalledReply</span>(<span style="color:#a6e22e">responseID</span>, <span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">jsonErr</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">rpcsLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Failed to marshal reply: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span>
    }

    <span style="color:#75715e">// Write the response.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">writeHTTPResponseHeaders</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>(), <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">buf</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">rpcsLog</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
        <span style="color:#66d9ef">return</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">msg</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">rpcsLog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Failed to write marshalled reply: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    }
</code></pre></div></li>
</ul>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js//highlight.min.js"></script>



<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166290945-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

