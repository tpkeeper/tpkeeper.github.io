<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.71.0-DEV" />


<title>btcd 源码分析系列：3 - connmanager - 大远的博客</title>
<meta property="og:title" content="btcd 源码分析系列：3 - connmanager - 大远的博客">


  <link href='http://www.tpkeep.com/favicon.jpg' rel='icon' type='image/x-icon'/>



  










<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/">首页</a></li>
    
    <li><a href="/post">归档</a></li>
    
    <li><a href="/tags">标签</a></li>
    
    <li><a href="/categories">分类</a></li>
    
    <li><a href="/about">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">4 min read</span>
    

    <h1 class="article-title">btcd 源码分析系列：3 - connmanager</h1>

    
    <span class="article-date">2019-08-30</span>
    

    <div class="article-content">
      <blockquote>
<p>参考：<a href="https://github.com/btcsuite/btcd/tree/master/connmgr">btcd</a></p>
</blockquote>
<ul>
<li>connmanamger 负责节点的连接处理，包括监听来自其他节点的连接请求和主动向其他节点发起连接请求，并将获取到的连接对象conn交给回调函数处理，实际上这些回调函数是由server实现的，它们会根据conn生成对应的peer，交由peer处理之后的逻辑</li>
<li>默认outbound peer数量为8</li>
<li>节点发现
<ul>
<li>address database （第一次启动时为空）</li>
<li>-addnode -connect (手动)</li>
<li>dns seed （通过dns获取addr）</li>
<li>hard-coded seeds（代码中的seed）</li>
<li>getaddr from other peers （通过其他节点同步）</li>
</ul>
</li>
</ul>
<h2 id="一创建connmanager对象">一、创建connmanager对象</h2>
<ul>
<li>主要是根据传入的config结构体参数返回一个指针，config结构体主要 包含一些回调方法和[]listener,这样便于灵活实现和调用</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// New returns a new connection manager.
</span><span style="color:#75715e">// Use Start to start connecting to the network.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">cfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Config</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">Dial</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrDialNil</span>
	}
	<span style="color:#75715e">// Default to sane values
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">RetryDuration</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">RetryDuration</span> = <span style="color:#a6e22e">defaultRetryDuration</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">TargetOutbound</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">TargetOutbound</span> = <span style="color:#a6e22e">defaultTargetOutbound</span>
	}
	<span style="color:#a6e22e">cm</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ConnManager</span>{
		<span style="color:#a6e22e">cfg</span>:      <span style="color:#f92672">*</span><span style="color:#a6e22e">cfg</span>, <span style="color:#75715e">// Copy so caller can&#39;t mutate
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">requests</span>: make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">interface</span>{}),
		<span style="color:#a6e22e">quit</span>:     make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}),
	}
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>, <span style="color:#66d9ef">nil</span>
}


<span style="color:#75715e">// Config holds the configuration options related to the connection manager.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// Listeners defines a slice of listeners for which the connection
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// manager will take ownership of and accept connections.  When a
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// connection is accepted, the OnAccept handler will be invoked with the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// connection.  Since the connection manager takes ownership of these
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// listeners, they will be closed when the connection manager is
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// stopped.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// This field will not have any effect if the OnAccept field is not
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// also specified.  It may be nil if the caller does not wish to listen
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// for incoming connections.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Listeners</span> []<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listener</span>

	<span style="color:#75715e">// OnAccept is a callback that is fired when an inbound connection is
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// accepted.  It is the caller&#39;s responsibility to close the connection.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Failure to close the connection will result in the connection manager
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// believing the connection is still active and thus have undesirable
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// side effects such as still counting toward maximum connection limits.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// This field will not have any effect if the Listeners field is not
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// also specified since there couldn&#39;t possibly be any accepted
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// connections in that case.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">OnAccept</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>)

	<span style="color:#75715e">// TargetOutbound is the number of outbound network connections to
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// maintain. Defaults to 8.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">TargetOutbound</span> <span style="color:#66d9ef">uint32</span>

	<span style="color:#75715e">// RetryDuration is the duration to wait before retrying connection
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// requests. Defaults to 5s.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RetryDuration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>

	<span style="color:#75715e">// OnConnection is a callback that is fired when a new outbound
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// connection is established.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">OnConnection</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">ConnReq</span>, <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>)

	<span style="color:#75715e">// OnDisconnection is a callback that is fired when an outbound
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// connection is disconnected.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">OnDisconnection</span> <span style="color:#66d9ef">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">ConnReq</span>)

	<span style="color:#75715e">// GetNewAddress is a way to get an address to make a network connection
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// to.  If nil, no new connections will be made automatically.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">GetNewAddress</span> <span style="color:#66d9ef">func</span>() (<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span>, <span style="color:#66d9ef">error</span>)

	<span style="color:#75715e">// Dial connects to the address on the named network. It cannot be nil.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Dial</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Addr</span>) (<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#66d9ef">error</span>)
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cmgr</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">connmgr</span>.<span style="color:#a6e22e">New</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">connmgr</span>.<span style="color:#a6e22e">Config</span>{
		<span style="color:#a6e22e">Listeners</span>:      <span style="color:#a6e22e">listeners</span>,
		<span style="color:#a6e22e">OnAccept</span>:       <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">inboundPeerConnected</span>,
		<span style="color:#a6e22e">RetryDuration</span>:  <span style="color:#a6e22e">connectionRetryInterval</span>,
		<span style="color:#a6e22e">TargetOutbound</span>: uint32(<span style="color:#a6e22e">targetOutbound</span>),
		<span style="color:#a6e22e">Dial</span>:           <span style="color:#a6e22e">hcdDial</span>,
		<span style="color:#a6e22e">OnConnection</span>:   <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">outboundPeerConnected</span>,
		<span style="color:#a6e22e">GetNewAddress</span>:  <span style="color:#a6e22e">newAddressFunc</span>,
	})
</code></pre></div><h2 id="二start">二、start</h2>
<ul>
<li>启动connhandler 处理connrequest请求结果，即处理主动向其他节点发起请求的结果</li>
<li>启动listenhandler 监听来自其他节点的连接</li>
<li>connrequest 向其他节点发起连接</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Start launches the connection manager and begins connecting to the network.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">Start</span>() {
	<span style="color:#75715e">// Already started?
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">start</span>, <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> {
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#e6db74">&#34;Connection manager started&#34;</span>)
	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connHandler</span>()

	<span style="color:#75715e">// Start all the listeners so long as the caller requested them and
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// provided a callback to be invoked when connections are accepted.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">OnAccept</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">listner</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">Listeners</span> {
			<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
			<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">listenHandler</span>(<span style="color:#a6e22e">listner</span>)
		}
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadUint64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connReqCount</span>); <span style="color:#a6e22e">i</span> &lt; uint64(<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">TargetOutbound</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">NewConnReq</span>()
	}
}
</code></pre></div><h2 id="三对监听到的连接的处理">三、对监听到的连接的处理</h2>
<ul>
<li>当有新的连接请求，会将此连接对象直接交给回调函数onAccept()处理，该函数的具体实现是在server中s.inboundPeerConnected()方法</li>
<li>s.inboundPeerConnected() 会创建一个inbound peer，并进入peer的处理逻辑</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// listenHandler accepts incoming connections on a given listener.  It must be
</span><span style="color:#75715e">// run as a goroutine.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">listenHandler</span>(<span style="color:#a6e22e">listener</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listener</span>) {
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Server listening on %s&#34;</span>, <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Addr</span>())
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">stop</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#75715e">// Only log the error if not forcibly shutting down.
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">stop</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Can&#39;t accept connection: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
			}
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">OnAccept</span>(<span style="color:#a6e22e">conn</span>)
	}

	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Tracef</span>(<span style="color:#e6db74">&#34;Listener handler done for %s&#34;</span>, <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Addr</span>())
}
</code></pre></div><p>onaccept的具体实现</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// inboundPeerConnected is invoked by the connection manager when a new inbound
</span><span style="color:#75715e">// connection is established.  It initializes a new inbound server peer
</span><span style="color:#75715e">// instance, associates it with the connection, and starts a goroutine to wait
</span><span style="color:#75715e">// for disconnection.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">server</span>) <span style="color:#a6e22e">inboundPeerConnected</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
	<span style="color:#a6e22e">sp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newServerPeer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#66d9ef">false</span>)
	<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">isWhitelisted</span> = <span style="color:#a6e22e">isWhitelisted</span>(<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">RemoteAddr</span>())
	<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Peer</span> = <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">NewInboundPeer</span>(<span style="color:#a6e22e">newPeerConfig</span>(<span style="color:#a6e22e">sp</span>))
	<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">AssociateConnection</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">peerDoneHandler</span>(<span style="color:#a6e22e">sp</span>)
}
</code></pre></div><h2 id="四对主动发起的连接的处理">四、对主动发起的连接的处理</h2>
<ul>
<li>生成一个新的请求id</li>
<li>然后将请求的结果统一发给connhandler处理</li>
<li>connhandler 根据不同的结果分别做不同的处理
<ul>
<li>如果成功则调用OnConnection回调函数，该函数由server的s.outboundPeerConnected（）实现</li>
<li>如果请求失败则调用自身的handleFailedConn()函数，尝试再次请求等逻辑</li>
</ul>
</li>
<li>s.outboundPeerConnected 同样是先创建一个outbound peer，然后进入peer的处理逻辑</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Connect assigns an id and dials a connection to the address of the
</span><span style="color:#75715e">// connection request.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">Connect</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnReq</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">stop</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadUint64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">id</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">StoreUint64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddUint64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">connReqCount</span>, <span style="color:#ae81ff">1</span>))
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Attempting to connect to %v&#34;</span>, <span style="color:#a6e22e">c</span>)
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Addr</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">requests</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">handleFailed</span>{<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span>}
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">requests</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">handleConnected</span>{<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">conn</span>}
	}
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// connHandler handles all connection related requests.  It must be run as a
</span><span style="color:#75715e">// goroutine.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// The connection handler makes sure that we maintain a pool of active outbound
</span><span style="color:#75715e">// connections so that we remain connected to the network.  Connection requests
</span><span style="color:#75715e">// are processed and mapped by their assigned ids.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">cm</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ConnManager</span>) <span style="color:#a6e22e">connHandler</span>() {
	<span style="color:#a6e22e">conns</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint64</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">ConnReq</span>, <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">TargetOutbound</span>)
<span style="color:#a6e22e">out</span>:
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">requests</span>:
			<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.(<span style="color:#66d9ef">type</span>) {

			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">handleConnected</span>:
				<span style="color:#a6e22e">connReq</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">c</span>
				<span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">updateState</span>(<span style="color:#a6e22e">ConnEstablished</span>)
				<span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">conn</span> = <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">conn</span>
				<span style="color:#a6e22e">conns</span>[<span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">id</span>] = <span style="color:#a6e22e">connReq</span>
				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Connected to %v&#34;</span>, <span style="color:#a6e22e">connReq</span>)
				<span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">retryCount</span> = <span style="color:#ae81ff">0</span>
				<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">failedAttempts</span> = <span style="color:#ae81ff">0</span>

				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">OnConnection</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
					<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">OnConnection</span>(<span style="color:#a6e22e">connReq</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">conn</span>)
				}

			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">handleDisconnected</span>:
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">connReq</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conns</span>[<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">id</span>]; <span style="color:#a6e22e">ok</span> {
					<span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">updateState</span>(<span style="color:#a6e22e">ConnDisconnected</span>)
					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">conn</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
					}
					<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Disconnected from %v&#34;</span>, <span style="color:#a6e22e">connReq</span>)
					delete(<span style="color:#a6e22e">conns</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">id</span>)

					<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">OnDisconnection</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
						<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">OnDisconnection</span>(<span style="color:#a6e22e">connReq</span>)
					}

					<span style="color:#66d9ef">if</span> uint32(len(<span style="color:#a6e22e">conns</span>)) &lt; <span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">cfg</span>.<span style="color:#a6e22e">TargetOutbound</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">retry</span> {
						<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">handleFailedConn</span>(<span style="color:#a6e22e">connReq</span>)
					}
				} <span style="color:#66d9ef">else</span> {
					<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Unknown connection: %d&#34;</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">id</span>)
				}

			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">handleFailed</span>:
				<span style="color:#a6e22e">connReq</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">c</span>
				<span style="color:#a6e22e">connReq</span>.<span style="color:#a6e22e">updateState</span>(<span style="color:#a6e22e">ConnFailed</span>)
				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Failed to connect to %v: %v&#34;</span>, <span style="color:#a6e22e">connReq</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">err</span>)
				<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">handleFailedConn</span>(<span style="color:#a6e22e">connReq</span>)
			}

		<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">quit</span>:
			<span style="color:#66d9ef">break</span> <span style="color:#a6e22e">out</span>
		}
	}

	<span style="color:#a6e22e">cm</span>.<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Trace</span>(<span style="color:#e6db74">&#34;Connection handler done&#34;</span>)
}

</code></pre></div><p>OnConnection的具体实现</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// outboundPeerConnected is invoked by the connection manager when a new
</span><span style="color:#75715e">// outbound connection is established.  It initializes a new outbound server
</span><span style="color:#75715e">// peer instance, associates it with the relevant state such as the connection
</span><span style="color:#75715e">// request instance and the connection itself, and finally notifies the address
</span><span style="color:#75715e">// manager of the attempt.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">server</span>) <span style="color:#a6e22e">outboundPeerConnected</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">connmgr</span>.<span style="color:#a6e22e">ConnReq</span>, <span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
	<span style="color:#a6e22e">sp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newServerPeer</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Permanent</span>)
	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">peer</span>.<span style="color:#a6e22e">NewOutboundPeer</span>(<span style="color:#a6e22e">newPeerConfig</span>(<span style="color:#a6e22e">sp</span>), <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Addr</span>.<span style="color:#a6e22e">String</span>())
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">srvrLog</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;Cannot create outbound peer %s: %v&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Addr</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">connManager</span>.<span style="color:#a6e22e">Disconnect</span>(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">ID</span>())
	}
	<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">Peer</span> = <span style="color:#a6e22e">p</span>
	<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">connReq</span> = <span style="color:#a6e22e">c</span>
	<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">isWhitelisted</span> = <span style="color:#a6e22e">isWhitelisted</span>(<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">RemoteAddr</span>())
	<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">AssociateConnection</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">peerDoneHandler</span>(<span style="color:#a6e22e">sp</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">addrManager</span>.<span style="color:#a6e22e">Attempt</span>(<span style="color:#a6e22e">sp</span>.<span style="color:#a6e22e">NA</span>())
}
</code></pre></div><p>a -&gt; b a向b节点发起连接</p>
<p>b：
某场景下触发了ban()和disconnect()，b会在banduration（默认24小时）之内，不允许a连接（onVersion里 最后调用addpeer()时判断，然后断掉连接）</p>
<p>a:在被b ban了之后，peer.start()会失败（在协商version时被b断开），接着调用disconnect()</p>
<p>server作为枢纽，处理connmanager和peer之间的协作</p>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js//highlight.min.js"></script>



<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166290945-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

