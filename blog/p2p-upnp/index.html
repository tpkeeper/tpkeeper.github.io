<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.71.0-DEV" />


<title>P2P对等网络 - upnp实现内网穿透 - 大远的博客</title>
<meta property="og:title" content="P2P对等网络 - upnp实现内网穿透 - 大远的博客">


  <link href='http://www.tpkeep.com/favicon.jpg' rel='icon' type='image/x-icon'/>



  










<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/">首页</a></li>
    
    <li><a href="/post">归档</a></li>
    
    <li><a href="/tags">标签</a></li>
    
    <li><a href="/categories">分类</a></li>
    
    <li><a href="/about">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">5 min read</span>
    

    <h1 class="article-title">P2P对等网络 - upnp实现内网穿透</h1>

    
    <span class="article-date">2019-12-31</span>
    

    <div class="article-content">
      <h2 id="什么是内网穿透">什么是内网穿透</h2>
<p>正常我们使用的电脑都是在局域网内部，我们的 ip 也是私有 ip。当我们请求网页的时候，先通过路由器，然后再到达目的服务器。既然我们自己电脑上的 ip 是私有的，服务器返回的网页是怎么到达我们个人的电脑上的呢？这个其实是路由器帮我们解决了这个问题。当我们的请求到达路由器时，它会将数据包的的原ip地址和端口替换为外网的ip和端口，这个外网的端口是随机产生的没有冲突的。服务端收到消息之后，自然会向这个外网ip和端口发送数据，而路由器会把所有接收到的关于这个外网端口的数据全部发给我们内网的电脑。相当于我们内网的ip+端口映射了一个外网的ip+端口，只要这个映射关系存在，内网就能与外网打通。这个机制其实可以通过 napt 协议自动来实现，无需手动配置。总结起来就是，我们内网向外网请求，然后有一个ip+端口的映射关系，然后就能愉快的上网了。但是有一个问题，就是这个映射关系只有内网才能触发，而且不用的话很快会清除并不会永存。如果外网想随时请求内网里的服务怎么办？我们把这个映射弄成持久的就行了，我们可以去路由器里手动配置这个映射关系，当然我们也可以通过 upnp 协议来自动设置，这样在我们写的程序里，只要发一个upnp 协议的消息就可以设置这个映射关系了。有了这个映射关系，外网甚至是另一个内网就可以通过我们的外网ip+端口，访问我们内网的服务了。也就是达到了所谓的内网穿透。</p>
<h2 id="什么是-upnp">什么是 upnp</h2>
<p>全名为 Universal Plug and Play，通用即插即用，通过 <a href="https://openconnectivity.org/developer/specifications/upnp-resources/upnp/">这里</a> 可以详细了解。这是一套开放的协议，旨在让局域网中的设备能够无缝连接并自动交换控制命令和信息，独立于任何操作系统、编程语言。最大的特点就是<strong>零配置和自动发现</strong>。具体的协议栈如下：
<img src="/image/upnp.png" alt="upnp.png"></p>
<p>可以看到，它们是基于互联网中已有的协议，又在上层定义了自己特有的一套协议。该协议栈中分为两个角色，被控制的设备和控制点，被控制的设备类似于一个server，控制点类似于一个client，它们之间通过这套协议通信。这两种都可以在各种类型的设备上实现比如个人电脑、嵌入式设备等。</p>
<p>所有的设备先获取ip地址，然后具体的工作过程可分为以下几步：</p>
<p><strong>1. 设备发现</strong></p>
<p>通过 ssdp 协议实现，该协议传输层使用 udp 协议，具体内容如下：</p>
<p>当控制点加入网络时，发送组播寻找 upnp 设备：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">M-SEARCH * HTTP/1.1  
HOST: 239.255.255.250:1900  
MAN: &#34;ssdp:discover&#34;  
MX: seconds to delay response  
ST: search target  
USER-AGENT: OS/version UPnP/2.0 product/version  
CPFN.UPNP.ORG: friendly name of the control point   
CPUUID.UPNP.ORG: uuid of the control point 
</code></pre></div><p>返回：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">HTTP/1.1 200 OK  
CACHE-CONTROL: max-age = seconds until advertisement expires  
DATE: when response was generated  
EXT:  
LOCATION: URL for UPnP description for root device  
SERVER: OS/version UPnP/2.0 product/version  
ST: search target  
USN: composite identifier for the advertisement  
BOOTID.UPNP.ORG: number increased each time device sends an initial announce or an update message  
CONFIGID.UPNP.ORG: number used for caching description information  
SEARCHPORT.UPNP.ORG: number identifies port on which device responds to unicast M-SEARCH 
</code></pre></div><p>当 upnp 设备加入网络，发送组播宣告自己的存在：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">NOTIFY * HTTP/1.1  
HOST: 239.255.255.250:1900  
LOCATION: URL for UPnP description for root device  
NT: notification type  
NTS: ssdp:update  
USN: composite identifier for the advertisement  
BOOTID.UPNP.ORG: BOOTID value that the device has used in its previous announcements  
CONFIGID.UPNP.ORG: number used for caching description information  
NEXTBOOTID.UPNP.ORG: new BOOTID value that the device will use in subsequent announcements  
SEARCHPORT.UPNP.ORG: number identifies port on which device responds to unicast M-SEARCH   
</code></pre></div><p><strong>2. 设备描述</strong></p>
<p>控制点获取设备描述，比如 UUID、服务</p>
<p>通过 soap 协议实现，该协议是基于 http 协议，传输层使用 tcp 协议，使用 xml 描述设备和服务：</p>
<p>设备描述：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>

<span style="color:#f92672">&lt;root</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;urn:schemas-upnp-org:device-1-0&#34;</span> <span style="color:#a6e22e">configId=</span><span style="color:#e6db74">&#34;configuration number&#34;</span><span style="color:#f92672">&gt;</span>  
  <span style="color:#f92672">&lt;specVersion&gt;</span> 
    <span style="color:#f92672">&lt;major&gt;</span>2<span style="color:#f92672">&lt;/major&gt;</span>  
    <span style="color:#f92672">&lt;minor&gt;</span>0<span style="color:#f92672">&lt;/minor&gt;</span> 
  <span style="color:#f92672">&lt;/specVersion&gt;</span>  
  <span style="color:#f92672">&lt;device&gt;</span> 
    <span style="color:#f92672">&lt;deviceType&gt;</span>urn:schemas-upnp-org:device:deviceType:v<span style="color:#f92672">&lt;/deviceType&gt;</span>  
    <span style="color:#f92672">&lt;friendlyName&gt;</span>short user-friendly title<span style="color:#f92672">&lt;/friendlyName&gt;</span>  
    <span style="color:#f92672">&lt;manufacturer&gt;</span>manufacturer name<span style="color:#f92672">&lt;/manufacturer&gt;</span>  
    <span style="color:#f92672">&lt;manufacturerURL&gt;</span>URL to manufacturer site<span style="color:#f92672">&lt;/manufacturerURL&gt;</span>  
    <span style="color:#f92672">&lt;modelDescription&gt;</span>long user-friendly title<span style="color:#f92672">&lt;/modelDescription&gt;</span>  
    <span style="color:#f92672">&lt;modelName&gt;</span>model name<span style="color:#f92672">&lt;/modelName&gt;</span>  
    <span style="color:#f92672">&lt;modelNumber&gt;</span>model number<span style="color:#f92672">&lt;/modelNumber&gt;</span>  
    <span style="color:#f92672">&lt;modelURL&gt;</span>URL to model site<span style="color:#f92672">&lt;/modelURL&gt;</span>  
    <span style="color:#f92672">&lt;serialNumber&gt;</span>manufacturer&#39;s serial number<span style="color:#f92672">&lt;/serialNumber&gt;</span>  
    <span style="color:#f92672">&lt;UDN&gt;</span>uuid:UUID<span style="color:#f92672">&lt;/UDN&gt;</span>  
    <span style="color:#f92672">&lt;UPC&gt;</span>Universal Product Code<span style="color:#f92672">&lt;/UPC&gt;</span>  
    <span style="color:#f92672">&lt;iconList&gt;</span> 
      <span style="color:#f92672">&lt;icon&gt;</span> 
        <span style="color:#f92672">&lt;mimetype&gt;</span>image/format<span style="color:#f92672">&lt;/mimetype&gt;</span>  
        <span style="color:#f92672">&lt;width&gt;</span>horizontal pixels<span style="color:#f92672">&lt;/width&gt;</span>  
        <span style="color:#f92672">&lt;height&gt;</span>vertical pixels<span style="color:#f92672">&lt;/height&gt;</span>  
        <span style="color:#f92672">&lt;depth&gt;</span>color depth<span style="color:#f92672">&lt;/depth&gt;</span>  
        <span style="color:#f92672">&lt;url&gt;</span>URL to icon<span style="color:#f92672">&lt;/url&gt;</span> 
      <span style="color:#f92672">&lt;/icon&gt;</span>  
      <span style="color:#75715e">&lt;!-- XML to declare other icons, if any, go here --&gt;</span> 
    <span style="color:#f92672">&lt;/iconList&gt;</span>  
    <span style="color:#f92672">&lt;serviceList&gt;</span> 
      <span style="color:#f92672">&lt;service&gt;</span> 
        <span style="color:#f92672">&lt;serviceType&gt;</span>urn:schemas-upnp-org:service:serviceType:v<span style="color:#f92672">&lt;/serviceType&gt;</span>  
        <span style="color:#f92672">&lt;serviceId&gt;</span>urn:upnp-org:serviceId:serviceID<span style="color:#f92672">&lt;/serviceId&gt;</span>  
        <span style="color:#f92672">&lt;SCPDURL&gt;</span>URL to service description<span style="color:#f92672">&lt;/SCPDURL&gt;</span>  
        <span style="color:#f92672">&lt;controlURL&gt;</span>URL for control<span style="color:#f92672">&lt;/controlURL&gt;</span>  
        <span style="color:#f92672">&lt;eventSubURL&gt;</span>URL for eventing<span style="color:#f92672">&lt;/eventSubURL&gt;</span> 
      <span style="color:#f92672">&lt;/service&gt;</span>  
      <span style="color:#75715e">&lt;!-- Declarations for other services defined by a UPnP Forum working committee          (if any) go here --&gt;</span>  
      <span style="color:#75715e">&lt;!-- Declarations for other services added by UPnP vendor (if any) go here --&gt;</span> 
    <span style="color:#f92672">&lt;/serviceList&gt;</span>  
    <span style="color:#f92672">&lt;deviceList&gt;</span> 
      <span style="color:#75715e">&lt;!-- Description of embedded devices defined by a UPnP Forum working committee         (if any) go here --&gt;</span>  
      <span style="color:#75715e">&lt;!-- Description of embedded devices added by UPnP vendor (if any) go here --&gt;</span> 
    <span style="color:#f92672">&lt;/deviceList&gt;</span>  
    <span style="color:#f92672">&lt;presentationURL&gt;</span>URL for presentation<span style="color:#f92672">&lt;/presentationURL&gt;</span> 
  <span style="color:#f92672">&lt;/device&gt;</span> 
<span style="color:#f92672">&lt;/root&gt;</span>
</code></pre></div><p>服务描述：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>

<span style="color:#f92672">&lt;scpd</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;urn:schemas-upnp-org:service-1-0&#34;</span> <span style="color:#a6e22e">xmlns:dt1=</span><span style="color:#e6db74">&#34;urn:domain-name:more-datatypes&#34;</span> <span style="color:#a6e22e">configId=</span><span style="color:#e6db74">&#34;configuration number&#34;</span><span style="color:#f92672">&gt;</span>  
  <span style="color:#f92672">&lt;specVersion&gt;</span> 
    <span style="color:#f92672">&lt;major&gt;</span>2<span style="color:#f92672">&lt;/major&gt;</span>  
    <span style="color:#f92672">&lt;minor&gt;</span>0<span style="color:#f92672">&lt;/minor&gt;</span> 
  <span style="color:#f92672">&lt;/specVersion&gt;</span>  
  <span style="color:#f92672">&lt;actionList&gt;</span> 
    <span style="color:#f92672">&lt;action&gt;</span> 
      <span style="color:#f92672">&lt;name&gt;</span>actionName<span style="color:#f92672">&lt;/name&gt;</span>  
      <span style="color:#f92672">&lt;argumentList&gt;</span> 
        <span style="color:#f92672">&lt;argument&gt;</span> 
          <span style="color:#f92672">&lt;name&gt;</span>argumentNameIn1<span style="color:#f92672">&lt;/name&gt;</span>  
          <span style="color:#f92672">&lt;direction&gt;</span>in<span style="color:#f92672">&lt;/direction&gt;</span>  
          <span style="color:#f92672">&lt;relatedStateVariable&gt;</span>stateVariableName<span style="color:#f92672">&lt;/relatedStateVariable&gt;</span> 
        <span style="color:#f92672">&lt;/argument&gt;</span>  
        <span style="color:#f92672">&lt;argument&gt;</span> 
          <span style="color:#f92672">&lt;name&gt;</span>argumentNameOut1<span style="color:#f92672">&lt;/name&gt;</span>  
          <span style="color:#f92672">&lt;direction&gt;</span>out<span style="color:#f92672">&lt;/direction&gt;</span>  
          <span style="color:#f92672">&lt;retval/&gt;</span>  
          <span style="color:#f92672">&lt;relatedStateVariable&gt;</span>stateVariableName<span style="color:#f92672">&lt;/relatedStateVariable&gt;</span> 
        <span style="color:#f92672">&lt;/argument&gt;</span>  
        <span style="color:#f92672">&lt;argument&gt;</span> 
          <span style="color:#f92672">&lt;name&gt;</span>argumentNameOut2<span style="color:#f92672">&lt;/name&gt;</span>  
          <span style="color:#f92672">&lt;direction&gt;</span>out<span style="color:#f92672">&lt;/direction&gt;</span>  
          <span style="color:#f92672">&lt;relatedStateVariable&gt;</span>stateVariableName<span style="color:#f92672">&lt;/relatedStateVariable&gt;</span> 
        <span style="color:#f92672">&lt;/argument&gt;</span> 
      <span style="color:#f92672">&lt;/argumentList&gt;</span> 
    <span style="color:#f92672">&lt;/action&gt;</span> 
  <span style="color:#f92672">&lt;/actionList&gt;</span>  
  <span style="color:#f92672">&lt;serviceStateTable&gt;</span> 
    <span style="color:#f92672">&lt;stateVariable&gt;</span> 
      <span style="color:#f92672">&lt;name&gt;</span>variableName<span style="color:#f92672">&lt;/name&gt;</span>  
      <span style="color:#f92672">&lt;dataType&gt;</span>basic data type<span style="color:#f92672">&lt;/dataType&gt;</span>  
      <span style="color:#f92672">&lt;defaultValue&gt;</span>default value<span style="color:#f92672">&lt;/defaultValue&gt;</span>  
      <span style="color:#f92672">&lt;allowedValueRange&gt;</span> 
        <span style="color:#f92672">&lt;minimum&gt;</span>minimum value<span style="color:#f92672">&lt;/minimum&gt;</span>  
        <span style="color:#f92672">&lt;maximum&gt;</span>maximum value<span style="color:#f92672">&lt;/maximum&gt;</span>  
        <span style="color:#f92672">&lt;step&gt;</span>increment value<span style="color:#f92672">&lt;/step&gt;</span> 
      <span style="color:#f92672">&lt;/allowedValueRange&gt;</span> 
    <span style="color:#f92672">&lt;/stateVariable&gt;</span>  
    <span style="color:#f92672">&lt;stateVariable&gt;</span> 
      <span style="color:#f92672">&lt;name&gt;</span>variableName<span style="color:#f92672">&lt;/name&gt;</span>  
      <span style="color:#f92672">&lt;dataType</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;dt1:variable data type&#34;</span><span style="color:#f92672">&gt;</span>string<span style="color:#f92672">&lt;/dataType&gt;</span>  
      <span style="color:#f92672">&lt;defaultValue&gt;</span>default value<span style="color:#f92672">&lt;/defaultValue&gt;</span>  
      <span style="color:#f92672">&lt;allowedValueList&gt;</span> 
        <span style="color:#f92672">&lt;allowedValue&gt;</span>enumerated value<span style="color:#f92672">&lt;/allowedValue&gt;</span> 
      <span style="color:#f92672">&lt;/allowedValueList&gt;</span> 
    <span style="color:#f92672">&lt;/stateVariable&gt;</span>  
    <span style="color:#f92672">&lt;stateVariable&gt;</span> 
      <span style="color:#f92672">&lt;name&gt;</span>variableName<span style="color:#f92672">&lt;/name&gt;</span>  
      <span style="color:#f92672">&lt;dataType</span> <span style="color:#a6e22e">type=</span><span style="color:#e6db74">&#34;dt2:vendor data type&#34;</span><span style="color:#f92672">&gt;</span>string<span style="color:#f92672">&lt;/dataType&gt;</span>  
      <span style="color:#f92672">&lt;defaultValue&gt;</span>default value<span style="color:#f92672">&lt;/defaultValue&gt;</span> 
    <span style="color:#f92672">&lt;/stateVariable&gt;</span> 
  <span style="color:#f92672">&lt;/serviceStateTable&gt;</span> 
<span style="color:#f92672">&lt;/scpd&gt;</span>

</code></pre></div><p><strong>3. 设备控制（描述之后即可发生）</strong></p>
<p>控制点发送控制命令给设备</p>
<p>通过 soap 协议实现，：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">POST path control URL HTTP/1.0  
HOST: hostname:portNumber  
CONTENT-LENGTH: bytes in body  
CONTENT-TYPE: text/xml; charset=&#34;utf-8&#34;  
USER-AGENT: OS/version UPnP/2.0 product/version  
SOAPACTION: &#34;urn:schemas-upnp-org:service:serviceType:v#actionName&#34;

<span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>

<span style="color:#f92672">&lt;s:Envelope</span> <span style="color:#a6e22e">xmlns:s=</span><span style="color:#e6db74">&#34;http://schemas.xmlsoap.org/soap/envelope/&#34;</span> <span style="color:#a6e22e">s:encodingStyle=</span><span style="color:#e6db74">&#34;http://schemas.xmlsoap.org/soap/encoding/&#34;</span><span style="color:#f92672">&gt;</span>  
  <span style="color:#f92672">&lt;s:Body&gt;</span> 
    <span style="color:#f92672">&lt;u:actionName</span> <span style="color:#a6e22e">xmlns:u=</span><span style="color:#e6db74">&#34;urn:schemas-upnp-org:service:serviceType:v&#34;</span><span style="color:#f92672">&gt;</span>  
      <span style="color:#f92672">&lt;argumentName&gt;</span>in arg value<span style="color:#f92672">&lt;/argumentName&gt;</span>  
      <span style="color:#75715e">&lt;!-- other in args and their values  go here, if any --&gt;</span> 
    <span style="color:#f92672">&lt;/u:actionName&gt;</span> 
  <span style="color:#f92672">&lt;/s:Body&gt;</span> 
<span style="color:#f92672">&lt;/s:Envelope&gt;</span>

</code></pre></div><p>返回：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">HTTP/1.0 200 OK  
CONTENT-TYPE: text/xml; charset=&#34;utf-8&#34;  
DATE: when response was generated  
SERVER: OS/version UPnP/2.0 product/version  
CONTENT-LENGTH: bytes in body

<span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>

&lt;<span style="color:#f92672">s:Envelope</span> <span style="color:#a6e22e">xmlns:s</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://schemas.xmlsoap.org/soap/envelope/&#34;</span> <span style="color:#a6e22e">s:encodingStyle</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://schemas.xmlsoap.org/soap/encoding/&#34;</span>&gt;  
  &lt;<span style="color:#f92672">s:Body</span>&gt; 
    &lt;<span style="color:#f92672">u:actionNameResponse</span> <span style="color:#a6e22e">xmlns:u</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;urn:schemas-upnp-org:service:serviceType:v&#34;</span>&gt;  
      &lt;<span style="color:#f92672">argumentName</span>&gt;out arg value&lt;/<span style="color:#f92672">argumentName</span>&gt;  
      <span style="color:#75715e">&lt;!-- other out args and their values go here, if any --&gt;</span> 
    &lt;/<span style="color:#f92672">u:actionNameResponse</span>&gt; 
  &lt;/<span style="color:#f92672">s:Body</span>&gt; 
&lt;/<span style="color:#f92672">s:Envelope</span>&gt;

</code></pre></div><p><strong>4. 设备事件（描述之后即可发生）</strong></p>
<p>设备状态更改，通知订阅监听事件的的控制点</p>
<p><strong>5. 展示（描述之后即可发生）</strong></p>
<p>控制点在获取设备的描述信息后比如url，就可以通过网页的形式展示信息</p>
<p>我们用来穿透内网的用到的就是步骤 1、2、3，接下来我们就通过代码来演示一下</p>
<h2 id="代码演示">代码演示</h2>
<p>为了演示，在局域网内部搭建了一个子网，这个子网用于模拟内网，外边的局域网用于模拟外网。内外网各有一台机器 a、b。</p>
<p>首先获取机器 a 的 ip，执行如下命令，获取到 a 的 ip 为 192.168.0.100</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ ifconfig |grep &#34;inet&#34;
	inet 127.0.0.1 netmask 0xff000000
	inet6 ::1 prefixlen 128
	inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1
	inet6 fe80::aede:48ff:fe00:1122%en6 prefixlen 64 scopeid 0x5
	inet6 fe80::828:a93c:e028:17a6%en1 prefixlen 64 secured scopeid 0x7
	inet 192.168.0.100 netmask 0xffffff00 broadcast 192.168.0.255
	inet6 fe80::e437:eff:fe97:3ff8%awdl0 prefixlen 64 scopeid 0x9
	inet6 fe80::e437:eff:fe97:3ff8%llw0 prefixlen 64 scopeid 0xa
	inet6 fe80::a4a:662a:3383:708f%utun0 prefixlen 64 scopeid 0x10
	inet6 fe80::6085:579d:d0b6:7aa1%utun1 prefixlen 64 scopeid 0x11
</code></pre></div><p>外网 b 的 ip 为 192.168.1.73，在内网中测试 b 联通性，访问正常</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ ping 192.168.1.73
PING 192.168.1.73 (192.168.1.73): 56 data bytes
64 bytes from 192.168.1.73: icmp_seq=0 ttl=63 time=1.706 ms
64 bytes from 192.168.1.73: icmp_seq=1 ttl=63 time=7.846 ms
64 bytes from 192.168.1.73: icmp_seq=2 ttl=63 time=1.561 ms
64 bytes from 192.168.1.73: icmp_seq=3 ttl=63 time=8.108 ms
</code></pre></div><p>在外网中测试内网 a 的联通性，无法访问，因为此时还未穿透内网，由外网无法访问内网的机器。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ ping 192.168.0.100
PING 192.168.0.100 (192.168.0.100) 56(84) bytes of data.

^C
--- 192.168.0.100 ping statistics ---
100 packets transmitted, 0 received, 100% packet loss, time 101364ms
</code></pre></div><p>我们在机器 a 上运行以下测试代码，这段代码会在发现设备（也就是路由器）之后，将外网的 6666 端口映射到内网 192.168.0.100 的 8888端口，并监听 8888端口：</p>
<p><em>upnp 协议相关代码使用的是 <a href="https://github.com/btcsuite/btcd/blob/master/upnp.go">btcd</a> 中的。</em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestDiscover</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">discovered</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">discoverUPnP</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">discovered</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;not discovered&#34;</span>)
	}
	<span style="color:#a6e22e">upnp</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">discovered</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">upnp</span>)
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">upnp</span>.<span style="color:#a6e22e">service</span>)
	<span style="color:#a6e22e">err</span><span style="color:#f92672">:=</span><span style="color:#a6e22e">upnp</span>.<span style="color:#a6e22e">AddMapping</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#ae81ff">6666</span>, <span style="color:#ae81ff">8888</span>,
		<span style="color:#e6db74">&#34;hcd listen port&#34;</span>, <span style="color:#ae81ff">20</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span><span style="color:#f92672">!=</span><span style="color:#66d9ef">nil</span>{
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">extIP</span>,<span style="color:#a6e22e">_</span><span style="color:#f92672">:=</span><span style="color:#a6e22e">upnp</span>.<span style="color:#a6e22e">ExternalIP</span>()
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;ExternalIP:&#34;</span>,<span style="color:#a6e22e">extIP</span>)
	<span style="color:#a6e22e">interIP</span>,<span style="color:#a6e22e">_</span><span style="color:#f92672">:=</span><span style="color:#a6e22e">upnp</span>.<span style="color:#a6e22e">internalAddress</span>()
	<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;internalAddress:&#34;</span>,<span style="color:#a6e22e">interIP</span>)


	<span style="color:#a6e22e">l</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:8888&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;listen error:&#34;</span>, <span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Accept</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;accept error:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#75715e">// start a new goroutine to handle
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// the new connection.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;a client come:&#34;</span>,<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">RemoteAddr</span>())
		<span style="color:#66d9ef">break</span>
	}
}
</code></pre></div><p>路由器的外网 ip 为 192.168.1.43，从 b 访问路由器 6666 端口，执行如下命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">telnet 192.168.1.43  6666
</code></pre></div><p>机器 a 输出如下，说明外网的机器 b 成功穿透了内网访问到了机器 a。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">natupnp_test.go:39: IGDv1-IP1
natupnp_test.go:46: ExternalIP: 192.168.1.143
natupnp_test.go:48: internalAddress: 192.168.0.100
natupnp_test.go:65: a client come: 192.168.1.73:57626
</code></pre></div>
    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js//highlight.min.js"></script>



<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166290945-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

