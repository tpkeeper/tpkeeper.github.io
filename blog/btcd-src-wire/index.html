<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.71.0-DEV" />


<title>btcd源码分析系列：5 - p2p网络的消息协议 - 大远的博客</title>
<meta property="og:title" content="btcd源码分析系列：5 - p2p网络的消息协议 - 大远的博客">


  <link href='http://www.tpkeep.com/favicon.jpg' rel='icon' type='image/x-icon'/>



  










<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/%3cnil%3e"
         width=""
         height=""
         alt="">
  </a>

  <ul class="nav-links">
    
    <li><a href="/">首页</a></li>
    
    <li><a href="/post">归档</a></li>
    
    <li><a href="/tags">标签</a></li>
    
    <li><a href="/categories">分类</a></li>
    
    <li><a href="/about">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">2 min read</span>
    

    <h1 class="article-title">btcd源码分析系列：5 - p2p网络的消息协议</h1>

    
    <span class="article-date">2019-08-30</span>
    

    <div class="article-content">
      <blockquote>
<p>参考：<a href="https://en.bitcoin.it/wiki/Protocol_documentation#Message_structure">protocol document</a> 、<a href="https://github.com/btcsuite/btcd/tree/master/wire">btcd</a></p>
</blockquote>
<ul>
<li>协议其实就是一个标准，btc有多种语言的实现版本，他们之间能够正常通信的基础就是共同遵守了这个标准。btc定义的协议有很多，包括p2p之间通信协议、交易认证协议、pow共识协议等等。本文主要分析<strong>p2p网络的消息协议及代码实现</strong></li>
<li>btc 的p2p网络的传输层支持tcp、udp、onion，应用层使用的即是本文讨论的消息协议</li>
</ul>
<h2 id="一message">一、Message</h2>
<p>一次通信以message为单位，具体结构如上图：
<img src="en-resource://database/532:1" alt="d018cee1eb87aabcbc1bd44609e2beb3.png"></p>
<p><strong>代码实现：</strong></p>
<h3 id="1通用接口定义">（1）通用接口定义</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Message is an interface that describes a bitcoin message.  A type that
</span><span style="color:#75715e">// implements Message has complete control over the representation of its data
</span><span style="color:#75715e">// and may therefore contain additional or fewer fields than those which
</span><span style="color:#75715e">// are used directly in the protocol encoded message.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">BtcDecode</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Reader</span>, <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">MessageEncoding</span>) <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">BtcEncode</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Writer</span>, <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">MessageEncoding</span>) <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">Command</span>() <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">MaxPayloadLength</span>(<span style="color:#66d9ef">uint32</span>) <span style="color:#66d9ef">uint32</span>
}
</code></pre></div><p>message 接口，定义通用方法，由具体的消息类型去实现</p>
<ul>
<li>BtcDecode BtcEnode 将结构化的消息体序列化为字节流 <strong>(对应payload)</strong> 或者将字节流实例化为某种消息格式</li>
<li>Commd 返回具体消息的命令字符串，标识不同的命令</li>
<li>MaxPayloadLength 最大payload 长度</li>
</ul>
<h3 id="2通用header">（2）通用header</h3>
<p><strong>Magic bytes</strong> are used as a way to identify the separate messages sent between nodes on the bitcoin network.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// messageHeader defines the header structure for all bitcoin protocol messages.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">messageHeader</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">magic</span>    <span style="color:#a6e22e">BitcoinNet</span> <span style="color:#75715e">// 4 bytes
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">command</span>  <span style="color:#66d9ef">string</span>     <span style="color:#75715e">// 12 bytes
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">length</span>   <span style="color:#66d9ef">uint32</span>     <span style="color:#75715e">// 4 bytes
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">checksum</span> [<span style="color:#ae81ff">4</span>]<span style="color:#66d9ef">byte</span>    <span style="color:#75715e">// 4 bytes
</span><span style="color:#75715e"></span>}
</code></pre></div><p>message header 结构体，定义通用部分字段</p>
<h3 id="3发送">（3）发送</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WriteMessageN</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Writer</span>, <span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">Message</span>, <span style="color:#a6e22e">pver</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">hcnet</span> <span style="color:#a6e22e">CurrencyNet</span>) (<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">totalBytes</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>

	<span style="color:#75715e">// Enforce max command size.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">command</span> [<span style="color:#a6e22e">CommandSize</span>]<span style="color:#66d9ef">byte</span>
	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Command</span>()
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">cmd</span>) &gt; <span style="color:#a6e22e">CommandSize</span> {
		<span style="color:#a6e22e">str</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;command [%s] is too long [max %v]&#34;</span>,
			<span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">CommandSize</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">totalBytes</span>, <span style="color:#a6e22e">messageError</span>(<span style="color:#e6db74">&#34;WriteMessage&#34;</span>, <span style="color:#a6e22e">str</span>)
	}
	copy(<span style="color:#a6e22e">command</span>[:], []byte(<span style="color:#a6e22e">cmd</span>))

	<span style="color:#75715e">// Encode the message payload.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">bw</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">BtcEncode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">bw</span>, <span style="color:#a6e22e">pver</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">totalBytes</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">payload</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bw</span>.<span style="color:#a6e22e">Bytes</span>()
	<span style="color:#a6e22e">lenp</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">payload</span>)

	<span style="color:#75715e">// Enforce maximum overall message payload.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">lenp</span> &gt; <span style="color:#a6e22e">MaxMessagePayload</span> {
		<span style="color:#a6e22e">str</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;message payload is too large - encoded &#34;</span><span style="color:#f92672">+</span>
			<span style="color:#e6db74">&#34;%d bytes, but maximum message payload is %d bytes&#34;</span>,
			<span style="color:#a6e22e">lenp</span>, <span style="color:#a6e22e">MaxMessagePayload</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">totalBytes</span>, <span style="color:#a6e22e">messageError</span>(<span style="color:#e6db74">&#34;WriteMessage&#34;</span>, <span style="color:#a6e22e">str</span>)
	}

	<span style="color:#75715e">// Enforce maximum message payload based on the message type.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mpl</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">MaxPayloadLength</span>(<span style="color:#a6e22e">pver</span>)
	<span style="color:#66d9ef">if</span> uint32(<span style="color:#a6e22e">lenp</span>) &gt; <span style="color:#a6e22e">mpl</span> {
		<span style="color:#a6e22e">str</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;message payload is too large - encoded &#34;</span><span style="color:#f92672">+</span>
			<span style="color:#e6db74">&#34;%d bytes, but maximum message payload size for &#34;</span><span style="color:#f92672">+</span>
			<span style="color:#e6db74">&#34;messages of type [%s] is %d.&#34;</span>, <span style="color:#a6e22e">lenp</span>, <span style="color:#a6e22e">cmd</span>, <span style="color:#a6e22e">mpl</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">totalBytes</span>, <span style="color:#a6e22e">messageError</span>(<span style="color:#e6db74">&#34;WriteMessage&#34;</span>, <span style="color:#a6e22e">str</span>)
	}

	<span style="color:#75715e">// Create header for the message.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hdr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">messageHeader</span>{}
	<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">magic</span> = <span style="color:#a6e22e">hcnet</span>
	<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">command</span> = <span style="color:#a6e22e">cmd</span>
	<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">length</span> = uint32(<span style="color:#a6e22e">lenp</span>)
	copy(<span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">checksum</span>[:], <span style="color:#a6e22e">chainhash</span>.<span style="color:#a6e22e">HashB</span>(<span style="color:#a6e22e">payload</span>)[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>])

	<span style="color:#75715e">// Encode the header for the message.  This is done to a buffer
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// rather than directly to the writer since writeElements doesn&#39;t
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// return the number of bytes written.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hw</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>(make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">MessageHeaderSize</span>))
	<span style="color:#a6e22e">writeElements</span>(<span style="color:#a6e22e">hw</span>, <span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">magic</span>, <span style="color:#a6e22e">command</span>, <span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">length</span>, <span style="color:#a6e22e">hdr</span>.<span style="color:#a6e22e">checksum</span>)

	<span style="color:#75715e">// Write header.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">hw</span>.<span style="color:#a6e22e">Bytes</span>())
	<span style="color:#a6e22e">totalBytes</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">n</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">totalBytes</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// Write payload.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">payload</span>)
	<span style="color:#a6e22e">totalBytes</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">n</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">totalBytes</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>发送message时，先发送header再发送payload</p>
<h2 id="二具体消息举例tx">二、具体消息举例：Tx</h2>
<p><img src="en-resource://database/568:1" alt="99cea19d9cefbb3d00df0c5331f6458e.png"></p>
<p><strong>代码实现：</strong></p>
<h3 id="1定义tx结构体">（1）定义tx结构体</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// MsgTx implements the Message interface and represents a bitcoin tx message.
</span><span style="color:#75715e">// It is used to deliver transaction information in response to a getdata
</span><span style="color:#75715e">// message (MsgGetData) for a given transaction.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// Use the AddTxIn and AddTxOut functions to build up the list of transaction
</span><span style="color:#75715e">// inputs and outputs.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MsgTx</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Version</span>  <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">TxIn</span>     []<span style="color:#f92672">*</span><span style="color:#a6e22e">TxIn</span>
	<span style="color:#a6e22e">TxOut</span>    []<span style="color:#f92672">*</span><span style="color:#a6e22e">TxOut</span>
	<span style="color:#a6e22e">LockTime</span> <span style="color:#66d9ef">uint32</span>
}
</code></pre></div><h3 id="2-接口实现">（2） 接口实现</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Command returns the protocol command string for the message.  This is part
</span><span style="color:#75715e">// of the Message interface implementation.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">msg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgTx</span>) <span style="color:#a6e22e">Command</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">CmdTx</span>
}

<span style="color:#75715e">// MaxPayloadLength returns the maximum length the payload can be for the
</span><span style="color:#75715e">// receiver.  This is part of the Message interface implementation.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">msg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MsgTx</span>) <span style="color:#a6e22e">MaxPayloadLength</span>(<span style="color:#a6e22e">pver</span> <span style="color:#66d9ef">uint32</span>) <span style="color:#66d9ef">uint32</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">MaxBlockPayload</span>
}

</code></pre></div><p>BtcDecode BtcEnode 不再赘述，具体可参考 <a href="https://github.com/btcsuite/btcd/blob/master/wire/msgtx.go">btcd</a></p>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" alt="Img link to Hugo website" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js//highlight.min.js"></script>



<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-166290945-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

